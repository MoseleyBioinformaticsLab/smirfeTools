---
title: "Calculating Sample EMF Proportions"
author: "Robert M Flight"
date: "`r Sys.time()`"
commit: "`r substr(git2r::branch_target(git2r::repository_head(git2r::repository())), 1, 8)`"
output: 
  pdf_document: 
    toc: yes
---

```{r setup, echo = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE)

library(smirfeTools)
library(dplyr)
library(ggplot2)
library(patchwork)
library(visualizationQualityControl)
```

```{r useful_functions}

```

## Purpose

Examine what portion of EMF space each sample contributes, both singly and in subsets.

## Terminology

* Assigned: the EMFs that were assigned by SMIRFE, regardless of e-value
* Voted: EMFs that were chosen by EMF-voting across samples via `smirfeTools`
* Full: The *full* set of EMFs
* Filtered: EMFs present in a certain proportion of a class of samples, normally
25% (or at least 2 samples).

## EMF Data

```{r mz_data}
mz_data = readRDS("compare_mz_frequency.rds")
emf_data = extract_imf_emf_data(mz_data$mz$emfs, by = "EMF")
full_propensity = extract_emf_propensity(emf_data$height)

sample_info = data.frame(sample = colnames(full_propensity),
                         stringsAsFactors = FALSE)
sample_info$disease <- "non-cancer"
sample_info[grepl("C+[[:digit:]]*pos", sample_info$sample, ignore.case = TRUE), "disease"] <- "cancer"
sample_info = dplyr::mutate(sample_info, patient = gsub("Cpos.*|Npos.*|N.pos.*|C.pos.*", "", sample, ignore.case = TRUE))
```

## Single Sample Voted Fractions

Take each sample, and from it's *Voted* EMFs calculate how much of the *Voted* and *Filtered*  EMFs it has as a percentage.

```{r voted_fractions}
full_propensity[is.na(full_propensity)] = 0
filtered_propensity = t(keep_non_zero_percentage(t(full_propensity), sample_classes = sample_info$disease, keep_num = 0.25))

full_voted_single = data.frame(sum = colSums(full_propensity),
                              sample = colnames(full_propensity),
                              stringsAsFactors = FALSE) %>%
  dplyr::mutate(fraction = sum / nrow(full_propensity) * 100,
                type = "full")
filtered_voted_single = data.frame(sum = colSums(filtered_propensity),
                              sample = colnames(filtered_propensity),
                              stringsAsFactors = FALSE) %>%
  dplyr::mutate(fraction = sum / nrow(filtered_propensity) * 100,
                type = "filtered")

```

```{r plot_voted}
fraction_voted_single = rbind(full_voted_single, filtered_voted_single)
ggplot(fraction_voted_single, aes(x = fraction)) + geom_histogram(bins = 30) +
  facet_wrap(~ type, ncol = 1, scales = "free_y") +
  labs(x = "fraction (%)", subtitle = "% Voted EMF Fraction by Sample")
```

## Group Voted Data

Take random subsets of samples that had a *voted filtered* fractional percentage in the range of 40-60%, and see what fraction of total EMFs they have. If more than 100 combinations exist, take 100. Finally, take the median value for that number of samples.

```{r group_samples}
sample_fractions = dplyr::left_join(filtered_voted_single, sample_info, by = "sample")
use_samples = dplyr::filter(sample_fractions, dplyr::between(fraction, 40, 60))
use_patients = dplyr::select(use_samples, patient) %>% dplyr::distinct() %>%
  dplyr::sample_n(20)

n_patient = seq(3, 10)

fraction_by_groups = purrr::map(n_patient, function(in_n){
  message(in_n)
  all_groups = combn(use_patients$patient, in_n)
  if (ncol(all_groups) > 100) {
    use_rows = sample(ncol(all_groups), 100)
    all_groups = all_groups[, use_rows]
  } 
  
  tmp_frac = purrr::map_df(seq(1, ncol(all_groups)), function(in_col){
    tmp_samples = dplyr::filter(sample_info, patient %in% all_groups[, in_col])
    
    tmp_propensity = full_propensity[, tmp_samples$sample]
    tmp_sum = rowSums(tmp_propensity)
    
    tmp_propensity2 = filtered_propensity[, tmp_samples$sample]
    tmp_sum2 = rowSums(tmp_propensity2)
    
    data.frame(frac = c(sum(tmp_sum > 0) / length(tmp_sum) * 100,
                        sum(tmp_sum2 > 0) / length(tmp_sum2) * 100),
               type = c("full", "filtered"),
               n_sample = nrow(tmp_samples),
               n_patient = in_n,
               stringsAsFactors = FALSE)
  })
  
}) 
```

```{r plot_groups}
fraction_medians = purrr::map_df(fraction_by_groups, function(in_group){
  dplyr::group_by(in_group, type) %>% dplyr::summarise(med = median(frac)) %>%
    dplyr::mutate(n_patient = in_group$n_patient[1])
})
ggplot(fraction_medians, aes(x = n_patient, y = med)) + geom_point() +
  facet_wrap(~ type, nrow = 1, scales = "free_y") +
  labs(x = "# of samples / group", y = "Median % fraction",
       subtitle = "% Full of Voted EMF Fraction by Group of Samples")
```

## Fraction of Assigned EMFs

Previous analyses are based on the **voted** EMFs. This time we will evaluate
what fraction of the voted EMFs were in the **assigned** EMFs for a particular
sample.

```{r assigned_emfs}
assigned_data = readRDS("frequencymz_assigned_data_lungmatched.rds")
names(assigned_data) = purrr::map_chr(assigned_data, "sample")
sample_emfs = purrr::map(assigned_data, function(in_data){
  dplyr::select(in_data$assignments, complete_EMF) %>% dplyr::distinct()
})

voted_emfs = purrr::map_df(emf_data$info, function(in_emf){
  dplyr::mutate(in_emf, semf = paste0(sudo_EMF, "_", sudo_group_EMF)) %>%
    dplyr::select(complete_EMF, semf) %>% dplyr::distinct()
})
```

```{r full_assigned_emfs}
total_emfs = length(unique(voted_emfs$semf))
full_assigned_fractions = purrr::imap_dfr(sample_emfs, function(sample_data, sample_id){
  tmp_emfs = dplyr::filter(voted_emfs, complete_EMF %in% sample_data$complete_EMF)
  data.frame(sample = sample_id,
             frac = length(unique(tmp_emfs$semf)) / total_emfs * 100,
             stringsAsFactors = FALSE)
})
ggplot(full_assigned_fractions, aes(x = frac)) + geom_histogram(bins = 30) +
  labs(x = "% fraction", subtitle = "% EMF for a Sample in All Voted EMFs")
```

```{r trimmed_assigned_emfs}
trimmed_emfs = dplyr::filter(voted_emfs, semf %in% rownames(filtered_propensity))
n_trimmed = length(unique(trimmed_emfs$semf))
trimmed_assigned_fractions = purrr::imap_dfr(sample_emfs, function(sample_data, sample_id){
  tmp_emfs = dplyr::filter(trimmed_emfs, complete_EMF %in% sample_data$complete_EMF)
  data.frame(sample = sample_id,
             frac = length(unique(tmp_emfs$semf)) / n_trimmed * 100,
             stringsAsFactors = FALSE)

})

ggplot(trimmed_assigned_fractions, aes(x = frac)) + geom_histogram(bins = 30) +
  labs(x = "% fraction", subtitle = "% EMF for a Sample in Trimmed Voted EMFs")
```

```{r group_samples_assigned}
assigned_by_groups = purrr::map(n_patient, function(in_n){
  message(in_n)
  all_groups = combn(use_patients$patient, in_n)
  if (ncol(all_groups) > 100) {
    use_rows = sample(ncol(all_groups), 100)
    all_groups = all_groups[, use_rows]
  } 
  
  tmp_frac = purrr::map_df(seq(1, ncol(all_groups)), function(in_col){
    tmp_samples = dplyr::filter(sample_info, patient %in% all_groups[, in_col])
    
    tmp_emfs = unique(unlist(purrr::map(sample_emfs[tmp_samples$sample], "complete_EMF")))
    filtered_full = dplyr::filter(voted_emfs, complete_EMF %in% tmp_emfs)
    
    filtered_trimmed = dplyr::filter(trimmed_emfs, complete_EMF %in% tmp_emfs)
    
    propensity_2 = filtered_propensity[, tmp_samples$sample]
    
    if (in_n == 3) {
      use_perc = 0.67
    } else {
      use_perc = 0.25
    }
    
    propensity_3 = t(keep_non_zero_percentage(t(propensity_2), tmp_samples$disease,
                                              keep_num = use_perc))
    
    
    data.frame(frac = c(length(unique(filtered_full$semf)) / total_emfs * 100,
                        length(unique(filtered_trimmed$semf)) / n_trimmed * 100,
                        nrow(propensity_3) / nrow(filtered_propensity) * 100),
               type = c("full", "trimmed", "kept"),
               n_sample = nrow(tmp_samples),
               n_patient = in_n,
               stringsAsFactors = FALSE)
  })
  
}) 
```

```{r plot_groups2}
assigned_medians = purrr::map_df(assigned_by_groups, function(in_group){
  dplyr::group_by(in_group, type) %>% dplyr::summarise(med = median(frac)) %>%
    dplyr::mutate(n_patient = in_group$n_patient[1])
})
assigned_medians$type = forcats::fct_relevel(assigned_medians$type, c("full", "trimmed", "kept"))
ggplot(assigned_medians, aes(x = n_patient, y = med)) + geom_point() +
  facet_wrap(~ type, nrow = 1, scales = "free_y") +
  labs(x = "# of samples / group", y = "Median % fraction")
```


## Which Group are High Samples From??

I'm curious to know which of the three frequency groups the high(er) fractional
groups are from?

```{r load_group_data}
group_data = readRDS("~/Projects/work/CESB/lungcancer_tissue_raw/positive/lungcancer_coefficient_df.rds")

sample_fractions = dplyr::left_join(sample_fractions, group_data, by = "sample")

ggplot(sample_fractions, aes(x = fraction, fill = group)) + geom_histogram(bins = 30) +
  facet_wrap(~ group, ncol = 1)
```